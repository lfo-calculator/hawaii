from requests import get
from requests.exceptions import RequestException
from contextlib import closing
from bs4 import BeautifulSoup
import os
import re

websiteBase = 'https://app.leg.wa.gov/RCW/'
websiteHomePage = 'https://app.leg.wa.gov/RCW/default.aspx?cite=77.15.410'
sub_alpha = '\([a-z]+\)'
sub_numeric = '\([0-9]+\)'
sub_roman = '\([ivx]+\)'

def simple_get(url):
    try:
        with closing(get(url, stream=True)) as resp:
            if is_good_response(resp):
                return resp.content
            else:
                return None

    except RequestException as e:
        log_error('Error during requests to {0} : {1}'.format(url, str(e)))
        return None

    
def is_good_response(resp):
    content_type = resp.headers['Content-Type'].lower()
    return (resp.status_code == 200
            and content_type is not None
            and content_type.find('html') > -1)


def log_error(e):
    print('My Error:', e, time.strftime(('%X %x %Z')))


def find_by_id(tag, is_label):
    return tag.has_attr('id') and tag['id'] == id_label


raw_html = simple_get(websiteHomePage)
if len(raw_html) == 0:
    print('No HTML retrieved')
else:
    html = BeautifulSoup(raw_html, 'html.parser')
    content = html.find('div', id='contentWrapper')
    divs = content.find_all('div')
    # First div has RCW and section number
    the_title = '## [' + divs[0].get_text() + ']'
    the_title = ' '.join(the_title.split())
    #print(the_title)

    # Second div has description of section
    the_script = divs[1].get_text()
    #print(the_script)

    # 3rd div has all the other divs
    the_text = divs[2].find_all('div')
    
    # remaining divs have text of section
    for i in range(0, len(the_text)):
        the_line = the_text[i].get_text()
        # indent according to regex
        if (re.search(sub_numeric, the_line)):
            the_line = '     ' + the_line
        print(the_text[i].get_text())
    
    #print(content.prettify())
